<!DOCTYPE html>
<html>
<style>
html, body {
  height: 100%;
  width: 100%;
}

iframe {
  overflow: hidden;
  height: 100%;
  width: 100%;
  margin: 0px;
}
</style>
<script src="util.js"></script>
<script>
function Authenticator() {
};

Authenticator.getInstance = function() {
  if (!Authenticator.instance_) {
    Authenticator.instance_ = new Authenticator();
  }
  return Authenticator.instance_;
}

Authenticator.prototype = {
  email_: null,
  password_: null,
  attemptToken_: null,
  frameLoaded_: false,

  // Input params from extension initialization URL.
  inputLang_ : undefined,
  intputEmail_ : undefined,

  GAIA_PAGE_ORIGIN: 'https://www.google.com',
  GAIA_PAGE_ORIGIN_NEW: 'https://accounts.google.com',
  GAIA_PAGE_PATH: '/accounts/ServiceLogin?service=chromeoslogin' +
      '&skipvpage=true&sarp=1&rm=hide' +
      '&continue=chrome-extension://mfffpogegjflfpflabcdkioaeobkgjik/' +
      'success.html',
  THIS_EXTENSION_ORIGIN: 'chrome-extension://mfffpogegjflfpflabcdkioaeobkgjik',
  PARENT_PAGE: 'chrome://oobe/',

  initialize: function() {
    console.log('### Authenticator.initialize');
    this.frameLoaded_ = false;

    var params = getUrlSearchParams(location.search);
    this.inputLang_ = params['hl'];
    this.inputEmail_ = params['email'];
    this.testEmail_ = params['test_email'];
    this.testPassword_ = params['test_password'];

    document.addEventListener('DOMContentLoaded', this.onPageLoad.bind(this));
  },

  isGaiaMessage_: function(msg) {
    return msg.origin == this.GAIA_PAGE_ORIGIN ||
           msg.origin == this.GAIA_PAGE_ORIGIN_NEW;
  },

  isInternalMessage_: function(msg) {
    return msg.origin == this.THIS_EXTENSION_ORIGIN;
  },

  getFrameUrl_: function() {
    var url = this.GAIA_PAGE_ORIGIN + this.GAIA_PAGE_PATH;
    if (this.inputLang_)
      url += '&hl=' + encodeURIComponent(this.inputLang_);
    if (this.inputEmail_)
      url += '&Email=' + encodeURIComponent(this.inputEmail_);
    if (this.testEmail_)
      url += '&test_email=' + encodeURIComponent(this.testEmail_);
    if (this.testPassword_)
      url += '&test_pwd=' + encodeURIComponent(this.testPassword_);
    return url;
  },

  loadFrame_: function() {
    console.log('Loading GAIA frame');
    $('gaia-frame').src = this.getFrameUrl_();
  },

  onFrameLoad: function(e) {
    console.log('### Authenticator.loadFrame_: Frame loaded.');
    self.frameLoaded_ = true;
  },

  onPageLoad: function(e) {
    window.addEventListener('offline', this.onOffline.bind(this), false);
    window.addEventListener('online', this.onOnline.bind(this), false);
    window.addEventListener('message', this.onMessage.bind(this), false);
    $('gaia-frame').addEventListener('load', this.onFrameLoad.bind(this));

    console.log('#### Authenticator.onPageLoad: navigator.onLine = ' + navigator.onLine);
    if (navigator.onLine) {
      console.log('#### Authenticator.onPageLoad: loading frame...');
      this.loadFrame_();
    }
  },

  onOffline: function(e) {
    if (this.frameLoaded_) {
      console.log('#### Authenticator.onOffline: went offline, cancel auth...');
      this.frameLoaded_ = false; // This triggers reload when back online.
      // TODO(zelidrag): Signal parent page that we can't complete auth process.
    }
  },

  onOnline: function(e) {
    if (!this.frameLoaded_) {
      // console.log('#### Authenticator.onOnline: loading frame...');
      this.loadFrame_();
    }
  },

  onLoginUILoaded: function() {
    var msg = {
      'method': 'loginUILoaded'
    };
    window.parent.postMessage(msg, this.PARENT_PAGE);
  },

  onMessage: function(e) {
    var msg = e.data;
    // console.log('#### Authenticator.onMessage: ' + JSON.stringify(msg));
    if (msg.method == 'attemptLogin' && this.isGaiaMessage_(e)) {
      this.email_ = msg.email;
      this.password_ = msg.password;
      this.attemptToken_ = msg.attemptToken;
    } else if (msg.method == 'clearOldAttempts' && this.isGaiaMessage_(e)) {
      this.email_ = null;
      this.password_ = null;
      this.attemptToken_ = null;
      this.onLoginUILoaded();
    } else if (msg.method == 'confirmLogin' && this.isInternalMessage_(e)) {
      if (this.attemptToken_ == msg.attemptToken) {
        var msg = {
          'method': 'completeLogin',
          'email': this.email_,
          'password': this.password_
        };
        window.parent.postMessage(msg, this.PARENT_PAGE);
      } else {
        console.log('#### Authenticator.onMessage: unexpected attemptToken!?');
      }
    } else {
      console.log('#### Authenticator.onMessage: unknown message + origin!?');
    }
  }
};

console.log('#### main.html start');
Authenticator.getInstance().initialize();
</script>
<body><iframe id="gaia-frame" src="about:blank"
  frameborder="0"></iframe></body></html>

